# 如何在垃圾收集发生时，让所有线程都跑到最近的安全点

### 说明

- 有两种方案可选择：抢先式中断(Preemptive Suspension)和主动式中断(Voluntary Suspension)
- 抢先式中断不需要线程的执行代码主动去配合，有垃圾收集发生时，系统首先把所有用户线程全部中断，如果发现有用户线程中断的地方不在安全点上，就恢复这条线程执行，让它一会再重新中断，知道跑到安全点上。现在几乎没有虚拟机实现和采用抢占式中断来暂停线程响应GC事件了。
- 而主动式中断的思想是当垃圾收集需要中断线程的时候，不直接对线程操作，仅仅简单地设置一个标志位，各个线程执行过程时会不停地主动去轮询这个标志，一旦发现中断标志位为真时就自己在最近的安全点上主动中断挂起。轮询标志的地方和安全点是重合的，另外还要加上所有创建对象和其他需要在java对上分配内存的地方，这是为了检查是否将要发生垃圾收集，避免没有足够内容分配新对象。