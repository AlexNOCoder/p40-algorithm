# Redis主从复制的核心原理

### 过程

1. 从节点执行salveof masterIp port，保存主节点信息 
   
2. 从节点中定时任务发现主节点信息，建立和主节点的socket连接
   
3. 从节点发送信号，主节点返回，两边能互相通信
   
4. 连接建立后，主节点将所有数据发送个从节点(数据同步)
   
5. 主节点把当前数据同步给从节点后，便完成了复制过程。接下来，主节点会持续的把写命令发送给从节点，保证主从数据一致性。

### 名词解释

- runId:每个redis节点启动都会生成唯一的uuid，每次redis重启，runId都会发生变化。
- offset：主从节点各自维护自己的复制偏移量offset，当主节点有写入命令时，offset = offset+命令的字节长度。从节点在收到主节点发送的命令后，也会增加自己的offset，并把自己的offset发送给主节点。主节点同时保存自己的offset和从节点的offset，通过对比offset来判断主从节点数据是否一致。
- repl_backlog_size:保存在主节点上的一个固定长度的先进先出队列，默认大小是1MB

### 全量复制
1. 从节点发送pysnc命令，pysnc runid offset
1. 主节点返回FULLRESYNC runId offset，runId是主节点的runId，offset是主节点目前的offset。从节点保存信息。
1. 主节点启动bgsave命令fork子进程进行RDB持久化
1. 主节点将RDB文件发送给从节点，到从节点加载数据完成之前，写命令写入缓冲区
1. 从节点清理本地数据并加载RDB，如果开启了AOF会重写AOF

### 部分复制

1. 复制偏移量：psync client offset
1. 复制积压缓冲区：主节点内部维护了一个固定长度的、先进先出队列作为复制积压缓冲区，当主节点offset的差距过大超过缓冲区长度时，将无法执行部分复制，只能执行全量复制
   - 如果从节点保存的runid与主节点现在的runid相同，说明主从节点之前同步过，主节点会继续尝试使用部分复制(到底能不能部分复制还要看offset和复制积压缓冲区的情况)
   - 如果从节点保存的runid与主节点现在的runid不同，说明从节点在断线前同步的Redis节点并不是当前的主节点，只能进行全量赋值。