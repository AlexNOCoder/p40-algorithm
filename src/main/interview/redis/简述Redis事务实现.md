# 简述Redis事务实现
### 事务说明
1. 事务开始
   - MULTI命令的执行，标识着一个事务的开始。MULTI命令会将客户端状态的flags属性中打开REDIS_MULTI标识来完成的。

2. 命令入队
   - 当一个客户端切换到事务状态之后，服务器会根据这个客户端发送来的命令来执行不同的操作。如果客户端发送的命令为MULTI、EXEC、WATCH、DISCARD中的一个，立即执行这个命令，否则将命令放入一个事务队列里面，然后向客户端返回QUEUE回复
   - 如果客户端发送的命令为EXEC、DISCARD、WATCH、MULTI四个命令的其中一个，那么服务器立即执行这个命令。
   - 如果客户端发送的四个命令以外的其他命令，那么服务器并不立即执行这个命令。
   - 首先检查此命令的格式是否正确，如果不正确，服务器会在客户端状态(redisClient)的flags属性关闭REDIS_MULTI标识，并且返回错误信息给客户端
   - 如果正确，将这个命令放入一个事务队列里面，然后向客户端返回QUEUE回复
   - 事务队列是按照FIFO的方式保存入列的命令
3. 事务执行
   - 客户端发送EXEC命令，服务器执行EXEC命令逻辑。
   - 如果客户端的flags属性不包含REDIS_MULTI标识，或者包含REDIS_DIRTY_CAS或者REDIS_DIRTY_EXEC标识，那么就直接取消事务的执行
   - 否则客户端处于事务状态(flags有REDIS_MULTI标识)，服务器会遍历客户端的事务队列，然后执行事务队列中的所有命令，最后返回结果全部给客户端
   - redis不支持事务回滚机制，但是它会检查每一个事务中的命令是否错误。
   - redis事务不支持检查那些程序员自己逻辑错误。例如对String类型的数据库键执行对HashMap类型的操作

### 事务命令
- WATCH命令是一个乐观锁，可以为Redis事务提供check-and-set(CAS)行为。可以监控一个或多个键，一旦其中有一个键被修改(或删除)，之后的事务就不会执行，监控一直持续到EXEC命令。
- MULTI命令用于开启一个事务，它总是返回OK。MULTI执行之后，客户端可以继续向服务器发送任意多条命令，这些命令不会立即被执行，而是被放到一个队列中，当EXEC命令被调用时，所有队列中的命令才会被执行
- EXEC：执行所有事务块内的命令。返回事务块内所有命令的返回值，按命令执行的先后顺序排列。当操作被打断时，返回空值nil。
- UNWATCH命令可以取消watch对所有key的监控。
