# 消息队列如何保证消息可靠传输

### 说明

- 消息可靠性传输代表了两层意识，既不能多也不能少
1. 为了保证消息不多，也就是消息不能重复，也就是生产者不能重复生产消息，或者消费者不能重复消费消息
   1. 首先要确保消息不多发，这个不常规出现，也比较难控制，因为如果出现多发，很大的原因是生产者自己的原因，如果要避免出现问题，就需要在消费端做控制。
   2. 要避免不重复消费，最保险的机制就是消费者实现幂等性，保证就算重复消费，也不会有问题，通过幂等性，也能解决消费者重复发送消息的问题
2. 消息不能少，意思就是消息不能丢失，生产者发送的消息，消费者一定要能消费到，对于这个问题，就要考虑两个方面
   1. 生产者发送消息时，要确认broker确实收到并持久化了这个消息，比如RabbitMQ的confirm机制，Kafka的ack机制都可以保证生产者能正确的将消息发送给broker
   2. broker要等待消费者真正确认消费到消息时才删除掉消息，这里通常就是消费端ack机制，消费者接收到一条消息后，如果确认没有问题了，就可以给broker发送一个ack，broker接收到ack后才会删除消息。