# mysql索引

# 说明
- **帮助mysql高效获取数据的数据结构**
   - 方便查找 ---检索
   - 索引查询内容 ---覆盖索引
- **一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往是存储在磁盘上的文件中的**
- **索引包括：聚集索引、覆盖索引、前缀索引、唯一索引**

- **索引的优点：**
  1. 被索引的列会自动进行排序，包括单列索引和组合索引，只是组合索引的排序要复杂一些
  2. 如果按照索引的顺序进行排序，对应order by语句来说，效率会提高很多
  3. where索引列在存储引擎层处理
  4. 覆盖索引，不需要回表查询

- **索引的缺点：**
  1. 会占用磁盘空间
  2. 虽然会提高查询效率，但是会降低更新表的效率。每次对表进行增删改操作，mysql不仅要保存数据，也要保持或者更新对应的索引文件

- **索引分类**
  - 单列索引
    1. 普通索引：允许在定义索引的列中插入重复值和空值，只是为了查询数据更快一些。add index
    2. 唯一索引：索引列中的值必须是唯一的，但是允许为空值。add unique index
    3.主键索引：是一种特殊的索引，不允许有空值。pk
  - 组合索引
    1. 在表中的多个字段组合上创建的索引 add index(col1,col2,..)
    2. 组合索引的使用，需要遵循最左前缀原则
    3. 一般情况下，建议使用组合索引替代单列索引（主键索引除外）
  - 全文索引
    1. 只有在MYISAM引擎、InnoDB(5.6以后)上才能使用，而且只能在CHAR、VARCHAR、TEXT类型字段上使用全文索引。fulltext
    2. 优先级最高，先执行，不会执行其他索引
    3.存储引擎决定执行一个索引
  - 空间索引
    1. 待完善

- **索引的使用：**
  - 创建索引
    1. 单列索引之普通索引
    
        ```sql
        create index index_name on table(column(length));
        alter table table_name add index index_name(column(length))
        ```

    2. 单列索引之唯一索引
    
        ```sql
        create unique index index_name on table(column(length))
        alter table table_name add unique index index_name(column(length))
        ```
       
    3. 单列索引之全文索引
        ```sql
        create fulltext index index_name on table(column(length))
        alter table table_name add fulltext index_name(column)
        ```    

    4. 组合索引
        ```sql
        alter table table_name add index index_aaa_bbb (aaa(50),bbb(10))
        ```
    
  - 删除索引
    ```sql
    drop index index_name on table
    ```

  - 查看索引
    ```sql
    show index from table _name
    ```

- **索引原理分析**
  - 索引的存储结构
    1. 索引是在存储引擎中实现的，也就是不同的存储引擎会使用不同的索引
    2. MyISAM和InnoDB存储引擎：只支持B+ TREE索引，也就是说默认使用BTREE，不能够更换
    3. MEMORY/HEAP存储引擎：支持HASH和BTREE索引
  - B树：是为了磁盘或者其它存储设备而设计的一种平衡查找树
    1. 高度一般都是2~4，输的高度直接影响IO读写的次数
    2. 如果三层树结构支持的数据可以达到20G，如果是四层数结构支撑的数据可以达到几十T
  - B树和B+树的区别
    1. B树的非叶子节点和叶子节点都会存储数据
    2. B+树只有叶子节点才会存储数据，而且存储的数据都是在一行上，而且这些数据都是有指针指向的，也就是有顺序的。

- **非聚集索引（MyISAM）**
  - B+树叶子节点只会存储数据行（数据文件）的指针，简单来说数据和索引不在一起，就是非聚集索引
  - 非聚集索引包含主键索引和辅助索引都会存储指针的值
  - 主键索引
  - 辅助索引
- **聚集索引（InnoDB)**
  - 主键索引（聚集索引）的叶子节点会存储数据行，也就是说数据和索引是在一起，这就是聚集索引。
  - 辅助索引之会存储主键值
  - 如果没有主键，则使用唯一索引建立聚集索引，如果没有唯一索引，mysql会按照一定的规则创建索引
  - 主键索引
    1. InnoDB要求表必须有主键（MyISAM可以没有）,如果没有显示指定，则mysql系统会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则mysql自动为InnoDB表生成一个隐含字段作为主键，类型为长整型。
  - 辅助索引（次要索引）
    1. 第二个与MyISAM索引的不同是InnoDB的辅助索引data域相应记录主键值而不是地址。换句话说，InnoDB的所有辅助索引都引用主键作为data域
  - 聚集索引这种实现方式使得主键的搜索十分高效，但是辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键得到主索引中检索获得记录。
    ```sql
      select * from user where name ='Alice' 回表查询 检索查询两次 非主键索引 --- pk --- 索引 ---> 数据
      select id,name from user where name = 'Alice' 不需要回表 在辅助索引树上就可以查询到 覆盖索引（多用组合索引）
    ```

- **哪些情况需要创建索引**
    1. 主键自动建立唯一索引
    2. 频繁作为查询条件的字段应该创建索引
    3. 多表关联查询中，关联字段应该创建索引 on两边都要创建索引
    4. 查询中排序的字段，应该创建索引
    5. 频繁查询字段 覆盖索引
    6. 查询中统计或者分组字段，应该创建索引 group by
- **哪些情况不需要创建索引**
    1. 表记录太少
    2. 经常进行增删改操作的表
    3. 频繁更新的字段
    4. where条件里使用频率不高的字段
- **组合索引**
    1. mysql创建组合索引的规则首先会对组合索引的最左边进行排序，然后对第二个字段
    2. 为了节省mysql索引存储空间以及提升搜索性能，可以创建组合索引（能使用组合索引就不使用单列索引）
    ```sql
    alter table 'table_name' add index index_name('col1','col2','cole')
    ```
    3. 组合索引能够省空间，并且更容易实现覆盖索引
    4. 遵循最左前缀原则
  
        1. 前缀索引 like a%   
        2. 从左向右匹配直到遇到范围查询 > < between like